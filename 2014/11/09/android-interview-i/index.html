<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android 面试题纪录 | 月光独奏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="1. JVM和DVM的不同

JVM is a stack-based machine; while DVM is register-based（can perform the same tasks using less  code）;
A stack-based virtual machine must transfer data from registers to the operand st">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 面试题纪录">
<meta property="og:url" content="http://yoursite.com/2014/11/09/android-interview-i/">
<meta property="og:site_name" content="月光独奏">
<meta property="og:description" content="1. JVM和DVM的不同

JVM is a stack-based machine; while DVM is register-based（can perform the same tasks using less  code）;
A stack-based virtual machine must transfer data from registers to the operand st">
<meta property="og:image" content="https://msolomoon.github.io/images/Zygote_VM_Startup.png">
<meta property="og:image" content="https://msolomoon.github.io/images/the_ui_thread_message_passing_api.png">
<meta property="og:image" content="https://msolomoon.github.io/images/IPC_through_Binder.png">
<meta property="og:image" content="https://msolomoon.github.io/images/AIDL_remote _procedure.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 面试题纪录">
<meta name="twitter:description" content="1. JVM和DVM的不同

JVM is a stack-based machine; while DVM is register-based（can perform the same tasks using less  code）;
A stack-based virtual machine must transfer data from registers to the operand st">

  
    <link rel="alternative" href="/atom.xml" title="月光独奏" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="http://msolo-programmer.qiniudn.com/msolo_me_square.png">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">月光独奏</a></h1>
		</hgroup>

		
		<p class="header-subtitle">软件设计及开发者</p>
		

		
			<div class="onoffswitch">
			    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch" checked>
			    <label class="onoffswitch-label" for="myonoffswitch">
			        <span class="onoffswitch-inner"></span>
			        <span class="onoffswitch-switch"></span>
			    </label>
			</div>
		

		<div class="switch-area">
			<section class="first-part">
				<nav class="header-menu">
					<ul>
					
						<li><a href="/">主页</a></li>
			        
						<li><a href="/archives">所有文章</a></li>
			        
						<li><a href="/categories/随笔">随笔</a></li>
			        
						<li><a href="/categories/摘录">摘录</a></li>
			        
						<li><a href="/categories/书籍">书籍</a></li>
			        
						<li><a href="/categories/Web">Web</a></li>
			        
						<li><a href="/categories/C-Cpp-Go">C/Cpp/Go</a></li>
			        
						<li><a href="/categories/java-android">Java/Android</a></li>
			        
						<li><a href="/categories/project">Project</a></li>
			        
						<li><a href="/categories/程序员日志">程序员日志</a></li>
			        
						<li><a href="/about">关于</a></li>
			        
					</ul>
				</nav>
				<nav class="header-nav">
					<div class="social">
						
							<a class="github" target="_blank" href="https://github.com/mSoloMoon" title="github">github</a>
				        
							<a class="weibo" target="_blank" href="http://t.qq.com/zhengguangyu_msolo" title="weibo">weibo</a>
				        
							<a class="email" target="_blank" href="mailto://yuezhi.msolo@outlook.com" title="email">email</a>
				        
							<a class="qq" target="_blank" href="/212499714" title="qq">qq</a>
				        
					</div>
				</nav>
			</section>
			
			
			<section class="second-part">
				<div class="widget tagcloud">
					<a href="/tags/Android/" style="font-size: 12.50px;">Android</a><a href="/tags/C-C/" style="font-size: 10.00px;">C/C++</a><a href="/tags/Go/" style="font-size: 10.00px;">Go</a><a href="/tags/IT问题录/" style="font-size: 10.00px;">IT问题录</a><a href="/tags/IT面试/" style="font-size: 15.00px;">IT面试</a><a href="/tags/Java/" style="font-size: 12.50px;">Java</a><a href="/tags/Java-Web/" style="font-size: 10.00px;">Java Web</a><a href="/tags/书籍笔记/" style="font-size: 12.50px;">书籍笔记</a><a href="/tags/历史/" style="font-size: 10.00px;">历史</a><a href="/tags/思考/" style="font-size: 12.50px;">思考</a><a href="/tags/摘录/" style="font-size: 10.00px;">摘录</a><a href="/tags/生活记录/" style="font-size: 17.50px;">生活记录</a><a href="/tags/软件开发/" style="font-size: 20.00px;">软件开发</a><a href="/tags/软件框架/" style="font-size: 12.50px;">软件框架</a><a href="/tags/随笔/" style="font-size: 17.50px;">随笔</a><a href="/tags/项目/" style="font-size: 12.50px;">项目</a>
				</div>
			</section>
			
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://msolo-programmer.qiniudn.com/msolo_me_square.png">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">月光独奏</a></h1>
			</hgroup>
			
			<p class="header-subtitle">软件设计及开发者</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories/随笔">随笔</a></li>
		        
					<li><a href="/categories/摘录">摘录</a></li>
		        
					<li><a href="/categories/书籍">书籍</a></li>
		        
					<li><a href="/categories/Web">Web</a></li>
		        
					<li><a href="/categories/C-Cpp-Go">C/Cpp/Go</a></li>
		        
					<li><a href="/categories/java-android">Java/Android</a></li>
		        
					<li><a href="/categories/project">Project</a></li>
		        
					<li><a href="/categories/程序员日志">程序员日志</a></li>
		        
					<li><a href="/about">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/mSoloMoon" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://t.qq.com/zhengguangyu_msolo" title="weibo">weibo</a>
			        
						<a class="email" target="_blank" href="mailto://yuezhi.msolo@outlook.com" title="email">email</a>
			        
						<a class="qq" target="_blank" href="/212499714" title="qq">qq</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <article id="post-android-interview-i" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/09/android-interview-i/" class="article-date">
  	<time datetime="2014-11-08T18:18:48.000Z" itemprop="datePublished">11月 9 2014</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/java-android/">java-android</a>
  </div>

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IT面试/">IT面试</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/软件开发/">软件开发</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android 面试题纪录
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-_JVM和DVM的不同">1. JVM和DVM的不同</h3>
<ul>
<li>JVM is a stack-based machine; while DVM is register-based（can perform the same tasks using less  code）;</li>
<li>A stack-based virtual machine must transfer data from registers to the operand stack before manipulating them. In contrast, a register-based VM operates by directly using virtual registers. This increases the relative size of instructions because they must specify which registers to use, but reduces the number of instructions that must be executed to achieve the same result.</li>
</ul>
<h3 id="2-_Android如何启动一个应用">2. Android如何启动一个应用</h3>
<p><img src="https://msolomoon.github.io/images/Zygote_VM_Startup.png" alt="Zygote启动应用流程"></p>
<ul>
<li>Android启动时将率先运行一个独特的进程<strong>Zygote</strong>。 而Zygote将启动一虚拟机，该虚拟机将预先加载Android核心库并初始化各种共享资源体，最后它将使用套接字进行监听。 </li>
<li>当用户启动一个Android应用时，Zygote将创建一个虚拟机以便其运行。它通过写时复制（Copy-On-Write）的技术拷贝Zygote虚拟机并以子进程的身份和其父进程共享内存实现的。</li>
</ul>
<h3 id="3-_UI_Thread_如何工作">3. UI Thread 如何工作</h3>
<p>The UI thread is managed by the platform internal class android.app.ActivityThread.</p>
<ul>
<li>默认情况下，为Android应用开发的代码都会通过主线程（UI Thread）运行；</li>
<li>如果应用不能在5秒内响应用户，那么用户将会看到一个显示ANR对话框并提供退出选项以允许用户终止该应用;</li>
<li>Android设计致力于同步人眼与硬件（屏幕）刷新率，这意味着Android每秒绘制屏幕60帧数；</li>
<li>Android平台线程通信拥有自己的处理机制（Message Passing Mechanism）。该机制以非阻塞生产者消费者模式实现，其生产者和消费者在消息传送时都不会被阻塞；另外生产者可往消息队列在任意时间任意位置中插入新的消息；</li>
<li>API 16之后，Android引进了一个新的Choreographer对象以监控帧数时序，并在连续丢掉30帧后在日志中生成丢帧的警告；</li>
</ul>
<a id="more"></a>

<p><strong>The UI thread Looper</strong></p>
<ul>
<li>UI Thread是唯一默认装配了Looper的线程，并且先于应用组件的初始化，另外该 Looper 不能通过 Looper.quit() 终止，否则抛出 RuntimeException；</li>
<li>关于UI Thread Looper和其它线程Looper的几点实用性区别: UI Thread Looper通过Looper.getMainLooper()可从任意位置获取；并且Looper是Android运行时环境是通过Looper.prepareMainLooper()方法装配的. 每一个应用只能进行装配一次，因此试图为其它线程装配将会抛出异常；</li>
</ul>
<p><strong>如何查看 UI Thread</strong></p>
<p>Below named com.eat is started by default when the application launches. Hence, that is the UI thread of the application.  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ adb shell ps -t | grep u0_a72</div><div class="line">USER      PID   PPID  VSIZE  RSS   WCHAN    PS         NAME</div><div class="line">u0_a72    <span class="number">4257</span>  <span class="number">144</span>   <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S com.eat</div><div class="line">u0_a72    <span class="number">4259</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S GC</div><div class="line">u0_a72    <span class="number">4262</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Signal Catcher</div><div class="line">u0_a72    <span class="number">4263</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S JDWP</div><div class="line">u0_a72    <span class="number">4264</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Compiler</div><div class="line">u0_a72    <span class="number">4265</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S ReferenceQueueDemon</div><div class="line">u0_a72    <span class="number">4266</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S FinalizerDaemon</div><div class="line">u0_a72    <span class="number">4267</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S FinalizerWatchdogDaemon</div><div class="line">u0_a72    <span class="number">4268</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Binder_1</div><div class="line">u0_a72    <span class="number">4269</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Binder_2</div></pre></td></tr></table></figure>

<p><strong>与UI Thread通信代码片段</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Runnable task = <span class="keyword">new</span> Runnable() {...};</div><div class="line"><span class="keyword">new</span> Handler(Looper.getMainLooper()).post(task);</div><div class="line"><span class="comment">// Method called on UI thread.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postFromUiThreadToUiThread</span>() {</div><div class="line">    <span class="keyword">new</span> Handler().post(<span class="keyword">new</span> Runnable() { ... });</div><div class="line">    <span class="comment">// The code at this point is part of a message being processed and is executed before the posted message.</span></div><div class="line">}</div><div class="line"><span class="comment">// Method called on UI thread.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postFromUiThreadToUiThread</span>() {</div><div class="line">    runOnUiThread(<span class="keyword">new</span> Runnable() { ... });</div><div class="line">		<span class="comment">// The code at this point is executed after the message.</span></div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="4-_UI_Thread_消息机制_API_概览">4. UI Thread 消息机制 API 概览</h3>
<blockquote>
<p>android.os.Handler: 消费者线程消息处理器，提供接口予以生产者线程往队列插入消息. 一个Looper或许有多个与之关联的Handler，但只有一个队列。<br>android.os.Looper: A message dispatcher associated with the one and only consumer thread.<br>android.os.MessageQueue: 无边界链表结构，每一个Looper和线程最多拥有一个消息队列。<br>android.os.Message: Message to be executed on the consumer thread.</p>
</blockquote>
<p><img src="https://msolomoon.github.io/images/the_ui_thread_message_passing_api.png" alt="message-passing机制概览"></p>
<ul>
<li>Insert: The producer thread inserts messages in the queue by using the Handler connected to the consumer thread.</li>
<li>Retrieve: The  Looper, runs in the consumer thread and retrieves messages from the queue in a sequential order.</li>
<li>Dispatch: The handlers are responsible for processing the messages on the consumer thread. A thread may have multiple Handler instances for processing messages; the Looper ensures that messages are dispatched to the correct Handler.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 示例: Basic Message Passing</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LooperActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>{</div><div class="line">    LooperThread mLooperThread;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{ <span class="comment">// for inserting messages in the queue</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">            Looper.prepare(); </div><div class="line">            mHandler = <span class="keyword">new</span> Handler() { </div><div class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) { </div><div class="line">                    <span class="keyword">if</span>(msg.what == <span class="number">0</span>) { doLongRunningOperation(); }</div><div class="line">                }</div><div class="line">            };</div><div class="line">			<span class="comment">// Start dispatching messages from the message queue to the consumer thread.</span></div><div class="line">			<span class="comment">// This is a blocking call, so the worker thread will not finish.</span></div><div class="line">            Looper.loop(); </div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Bundle savedInstanceState) {</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mLooperThread = <span class="keyword">new</span> LooperThread(); </div><div class="line">        mLooperThread.start();</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span>(View v) {</div><div class="line">        <span class="keyword">if</span> (mLooperThread.mHandler != <span class="keyword">null</span>) {</div><div class="line">            Message msg = mLooperThread.mHandler.obtainMessage(<span class="number">0</span>); </div><div class="line">            mLooperThread.mHandler.sendMessage(msg); <span class="comment">// Insert the message in the queue.</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doLongRunningOperation</span>() {</div><div class="line">        <span class="comment">// Add long running operation here.</span></div><div class="line">    }</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span>() {</div><div class="line">        mLooperThread.mHandler.getLooper().quit(); <span class="comment">// Terminate the background thread.</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="5-_阐述_MessageQueue-IdleHandler">5. 阐述 MessageQueue.IdleHandler</h3>
<blockquote>
<p>If there is no message to process, a consumer thread has some idle time. Instead of waiting, the thread can be utilized to execute other tasks during these idle slots.<br>When the message queue detects idle time for the consumer thread, it invokes queueIdle() on all registered IdleHandler-instances. It is up to the application to implement the callback responsibly. You should usually avoid long-running tasks because they will delay pending messages during the time they run.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Get the message queue of the current thread.</span></div><div class="line">MessageQueue mq = Looper.myQueue();</div><div class="line"><span class="comment">// Create and register an idle listener.</span></div><div class="line">MessageQueue.IdleHandler idleHandler = <span class="keyword">new</span> MessageQueue.IdleHandler();</div><div class="line">mq.addIdleHandler(idleHandler)</div><div class="line"><span class="comment">// Unregister an idle listener.</span></div><div class="line">mq.removeIdleHandler(idleHandler)</div><div class="line"></div><div class="line">interface IdleHandler {</div><div class="line">    <span class="keyword">boolean</span> queueIdle();</div><div class="line">}</div><div class="line"><span class="comment">// The implementation of queueIdle() must return a Boolean value with the following meanings:</span></div><div class="line"><span class="comment">// true: The idle handler is kept active; it will continue to receive callbacks for successive idle time slots.</span></div><div class="line"><span class="comment">// false: The idle handler is inactive; it will not receive anymore callbacks for successive idle time  slots.  </span></div><div class="line"><span class="comment">// This is the same thing as removing the listener through Message Queue.removeIdleHandler().</span></div></pre></td></tr></table></figure>

<h3 id="6-_Android_平台如何调度线程">6. Android 平台如何调度线程</h3>
<p><strong>Priority</strong>：Change the Linux thread priority.</p>
<ul>
<li>java.lang.Thread: </li>
<li>setPriority(int priority);    // from 0 (least prioritized) to 10 (most prioritized).</li>
<li>android.os.Process</li>
<li>Process.setThreadPriority(int priority); // Calling thread.</li>
<li>Process.setThreadPriority(int threadId, int priority);    // Thread with specific id.</li>
</ul>
<p><strong>Control group</strong>： Change the Android-specific control group.  </p>
<ul>
<li>Android defines multiple control groups, but the most important ones for applications are the Foreground Group and Background Group.</li>
<li>The threads created by the application by default have the same priority and control group membership as the UI thread, so they compete on equal terms for processor allocation.</li>
<li>To solve problem that lots of background threads may reduce the performance of the UI thread, it’s possible to decouple background threads from the control group where the application threads execute by default.</li>
<li>Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND)  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ adb shell ps -P | grep u0_a72		<span class="comment"># show foreground thread </span></div><div class="line">u0_a72    <span class="number">4257</span>  <span class="number">144</span>   <span class="number">320304</span> <span class="number">34504</span> fg  ffffffff <span class="number">00000000</span> S com.eat</div></pre></td></tr></table></figure>

<h3 id="7-_Android下线程有哪些通信方式">7. Android下线程有哪些通信方式</h3>
<p><strong>Pipe</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> BUFFER_SIZE_IN_CHARS = <span class="number">1024</span> * <span class="number">4</span>;</div><div class="line">PipedReader r = <span class="keyword">new</span> PipedReader(BUFFER_SIZE_IN_CHARS);	<span class="comment">// default is 1024</span></div><div class="line">PipedWriter w = <span class="keyword">new</span> PipedWriter(r);</div><div class="line">Thread t = <span class="keyword">new</span> MyReaderThread(r);</div><div class="line">t.start();</div><div class="line"><span class="comment">// Producer thread: Flush the pipe after a write.</span></div><div class="line">w.write(<span class="string">'A'</span>);</div><div class="line">w.flush();</div><div class="line"><span class="comment">// Consumer thread: Read the data in a loop.</span></div><div class="line"><span class="keyword">int</span> i;</div><div class="line"><span class="comment">// when the buffer is empty, the PipedReader uses a blocking call to wait() with one-second timeout.</span></div><div class="line"><span class="keyword">while</span>((i = reader.read()) != -<span class="number">1</span>){	</div><div class="line">    <span class="keyword">char</span> c = (<span class="keyword">char</span>) i; </div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line">w.close();</div><div class="line">r.close();</div></pre></td></tr></table></figure>

<p><strong>Shared Memory</strong></p>
<p><strong>Signaling</strong>（be considered as the most error-prone technique）</p>
<ul>
<li><ol>
<li>synchronized: Object.wait() / Object.wait(timeout); Object.notify() / Object.notifyAll()</li>
</ol>
</li>
<li><ol>
<li>ReentrantLock: Condition.await() / Condition.await(timeout); Condition.signal() / Condition.signalAll()</li>
</ol>
</li>
<li><ol>
<li>ReentrantReadWriteLock: Condition.await() / Condition.await(timeout); Condition.signal() / Condition.signalAll() </li>
</ol>
</li>
</ul>
<p><strong>BlockingQueue</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerProducer</span> </span>{</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> LIMIT = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> BlockingQueue&lt;Integer&gt; blockingQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Integer&gt;(LIMIT);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span>() <span class="keyword">throws</span> InterruptedException {</div><div class="line">        <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            blockingQueue.put(value++);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consume</span>() <span class="keyword">throws</span> InterruptedException {</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            <span class="keyword">int</span> value = blockingQueue.take();</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>Android Message Passing</strong>（参考第4题）</p>
<ul>
<li>The lifecycle of a message: create(<strong>initialized</strong>) -&gt; enqueue(<strong>pending</strong>) -&gt; dispatch(<strong>dispatched</strong>) -&gt; recycle(<strong>recycled</strong>) -&gt; (<strong>initialized</strong>)</li>
</ul>
<blockquote>
<p>Message creation API:<br>Message m  = new Message();<br>Message m = Message.obtain();    // empty message<br>Message m = Message.obtain(Handler h);<br>Message m = Message.obtain(Handler h, int what);<br>Message m = Message.obtain(Handler h, int what, Object o);<br>Message m = Message.obtain(Handler h, int what, int arg1, int arg2);<br>Message m = Message.obtain(Handler h, int what, int arg1, int arg2, Object o);<br>Message m = Message.obtain(Handler h, Runnable task);    // task message<br>Message m = Message.obtain(Message originalMsg); // copy constructor</p>
</blockquote>
<p>Handler</p>
<ul>
<li>Setup</li>
<li>Constructors without an explicit Looper bind to the Looper of the current thread: new Handler(); 或    new Handler(Handler.Callback)</li>
<li>Constructors with an explicit  Looper bind to that  Looper: new Handler(Looper); 或 new Handler(Looper, Handler.Callback);</li>
<li>Message creation (参考上面)</li>
<li>Message insertion,  The sorting is based on the time parameter, and it is the only way an application can affect the dispatch order: default（Immediately eligible for dispatch），at_front（dispatch at time 0. Hence, it will be the next dispatched message, unless another is inserted at the front before this one is processed）, delay（The amount of time after which this message is eligible for dispatch），uptime（The absolute time at which this message is eligible for dispatch）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Add a task to the message queue:</span></div><div class="line"><span class="keyword">boolean</span> post(Runnable r)</div><div class="line"><span class="keyword">boolean</span> postAtFrontOfQueue(Runnable r)</div><div class="line"><span class="keyword">boolean</span> postAtTime(Runnable r, Object token, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> postAtTime(Runnable r, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> postDelayed(Runnable r, <span class="keyword">long</span> delayMillis)</div><div class="line"><span class="comment">// Add a data object to the message queue:</span></div><div class="line"><span class="keyword">boolean</span> sendMessage(Message msg)</div><div class="line"><span class="keyword">boolean</span> sendMessageAtFrontOfQueue(Message msg)</div><div class="line"><span class="keyword">boolean</span> sendMessageAtTime(Message msg, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> sendMessageDelayed(Message msg, <span class="keyword">long</span> delayMillis)</div><div class="line"><span class="comment">// Add simple data object to the message queue:</span></div><div class="line"><span class="keyword">boolean</span> sendEmptyMessage(<span class="keyword">int</span> what)</div><div class="line"><span class="keyword">boolean</span> sendEmptyMessageAtTime(<span class="keyword">int</span> what, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> sendEmptyMessageDelayed(<span class="keyword">int</span> what, <span class="keyword">long</span> delayMillis)</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// Message insertion errors</span></div><div class="line"><span class="comment">// RuntimeException: Message has no Handler; Message has already been dispatched and is being processed.</span></div><div class="line"><span class="comment">// Return false: Message is inserted after Looper.quit() has been called.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// example 1</span></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{</div><div class="line">    <span class="keyword">private</span> Handler mBackgroundHandler;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">        Looper.prepare();</div><div class="line">        mBackgroundHandler = <span class="keyword">new</span> Handler(); </div><div class="line">        Looper.loop();</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span>() {</div><div class="line">        mBackgroundHandler.post(<span class="keyword">new</span> Runnable() { </div><div class="line">        		<span class="annotation">@Override</span></div><div class="line">        		<span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">        				Message uiMsg = mUiHandler.obtainMessage(SHOW_PROGRESS_BAR, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>); </div><div class="line">        				mUiHandler.sendMessage(uiMsg); </div><div class="line">        				Random r = <span class="keyword">new</span> Random();</div><div class="line">        				<span class="keyword">int</span> randomInt = r.nextInt(<span class="number">5000</span>);</div><div class="line">        				SystemClock.sleep(randomInt); </div><div class="line">        				uiMsg = mUiHandler.obtainMessage(HIDE_PROGRESS_BAR, randomInt, <span class="number">0</span>, <span class="keyword">null</span>); </div><div class="line">        				mUiHandler.sendMessage(uiMsg); </div><div class="line">        		}</div><div class="line">        });</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exit</span>() { </div><div class="line">        mBackgroundHandler.getLooper().quit();</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler mUiHandler = <span class="keyword">new</span> Handler() {</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">        <span class="keyword">switch</span>(msg.what) {</div><div class="line">            <span class="keyword">case</span> SHOW_PROGRESS_BAR: </div><div class="line">                mProgressBar.setVisibility(View.VISIBLE);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HIDE_PROGRESS_BAR:</div><div class="line">                mText.setText(String.valueOf(msg.arg1));</div><div class="line">                mProgressBar.setVisibility(View.INVISIBLE);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">};</div><div class="line"><span class="comment">// example 2</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerCallbackActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span> </span>{</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span>(Message msg) { </div><div class="line">        <span class="keyword">switch</span> (msg.what) {</div><div class="line">            <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                msg.what = <span class="number">11</span>;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                msg.what = <span class="number">22</span>;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onHandlerCallback</span>(View v) {</div><div class="line">        Handler handler = <span class="keyword">new</span> Handler(<span class="keyword">this</span>) {</div><div class="line">            <span class="annotation">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">                <span class="comment">// Process message </span></div><div class="line">            }</div><div class="line">        };</div><div class="line">        handler.sendEmptyMessage(<span class="number">1</span>); </div><div class="line">        handler.sendEmptyMessage(<span class="number">2</span>); </div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Remove a task from the message queue</span></div><div class="line">removeCallbacks(Runnable r)</div><div class="line">removeCallbacks(Runnable r, Object token)</div><div class="line"><span class="comment">// Remove a data message from the message queue</span></div><div class="line">removeMessages(<span class="keyword">int</span> what)</div><div class="line">removeMessages(<span class="keyword">int</span> what, Object object)</div><div class="line"><span class="comment">// Remove tasks and data messages from the message queue</span></div><div class="line">removeCallbacksAndMessages(Object token)</div><div class="line"><span class="comment">// Taking a snapshot of the current message queue</span></div><div class="line">mWorkerHandler.dump(<span class="keyword">new</span> LogPrinter(Log.DEBUG, TAG), <span class="string">""</span>);</div><div class="line"><span class="comment">// Tracing the message queue processing</span></div><div class="line">Looper.myLooper().setMessageLogging(<span class="keyword">new</span> LogPrinter(Log.DEBUG, TAG));</div></pre></td></tr></table></figure>

<h3 id="8-_进程间如何通信">8. 进程间如何通信</h3>
<p><strong>Android RPC</strong></p>
<ul>
<li>IPC由Linux系统管理，支持以下几种IPC机制: signals, pipes, message queues, semaphores, and shared memory. 而经过修改过的Android版Linux，其IPC机制已被替换为binder框架，该框架使用RPC方式在进程间通信。</li>
</ul>
<blockquote>
<p>RPC方式通信包含以下步骤：</p>
<ol>
<li>Method and data decomposition, also known as marshalling</li>
<li>Transferring the marshalled information to the remote process</li>
<li>Recomposing the information in the remote process, also known as unmarshalling</li>
<li>Transferring return values back to the originating process</li>
</ol>
</blockquote>
<p><strong>Binder</strong></p>
<p><img src="https://msolomoon.github.io/images/IPC_through_Binder.png" alt="IPC through binder"></p>
<ul>
<li>客户端线程在交互时默认是阻塞的，直到远程的线程完成onTransact()方法。</li>
<li>交互数据由对象android.os.Parcel组成, 该对象经过优化以便通过Binder和进程交互。</li>
<li>onTransact()方法在binder线程池中的某一线程执行。该线程池存在的意义只在于为了处理从其它进程而来的消息；不过它最多只能有16个线程。</li>
<li>IPC可以是双通道的。</li>
</ul>
<p><strong>AIDL（Android Interface Definition Language）</strong></p>
<p><img src="https://msolomoon.github.io/images/AIDL_remote _procedure.png" alt="AIDL remote procedure"></p>
<ul>
<li>The generated Java interface is included in all the client applications and in the server application. The interface file defines two inner classes,  Proxy and  Stub, that handle all the marshalling and unmarshalling of the data, as well as the transaction itself. </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Synchronous RPC : ISynchronous.aidl</span></div><div class="line">interface ISynchronous {</div><div class="line">    String getThreadNameFast();</div><div class="line">    String getThreadNameSlow(<span class="keyword">long</span> sleep);</div><div class="line">    String getThreadNameBlocking();</div><div class="line">    String getThreadNameUnblock();</div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ISynchronous.Stub mBinder = <span class="keyword">new</span> ISynchronous.Stub() {</div><div class="line">    CountDownLatch mLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> String <span class="title">getThreadNameFast</span>() <span class="keyword">throws</span> RemoteException {</div><div class="line">        <span class="keyword">return</span> Thread.currentThread().getName();</div><div class="line">    }</div><div class="line">    <span class="comment">//...</span></div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line">ISynchronous mISynchronous = ISynchronous.Stub.asInterface(binder);</div><div class="line">String remoteThreadName = mISynchronous.getThreadNameFast();</div></pre></td></tr></table></figure>

<p><strong>未完待续</strong></p>

      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/11/09/begin-hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          程序员的自我修养 - 从Hello World！说起
        
      </div>
    </a>
  
  
    <a href="/2014/11/08/project-stockeye-package-calendarstock/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Stockeye项目 - CalendarStock包（初步设计）</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="android-interview-i" data-title="Android 面试题纪录" data-url="http://yoursite.com/2014/11/09/android-interview-i/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2014 月光独奏
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

  <script src="/js/main.js" type="text/javascript"></script>


  </div>
</body>
</html>