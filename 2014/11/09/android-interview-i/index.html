<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Android 面试题纪录（一） | 月光独奏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="目录

JVM和DVM的不同
Android如何启动一个应用
UI Thread 如何工作
UI Thread 消息机制 API 概览
阐述 MessageQueue.IdleHandler
Android 平台如何调度线程
Android下线程有哪些通信方式
进程间如何通信
Android 如何管理内存 


1. JVM和DVM的不同

JVM is a stack-based machine">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 面试题纪录（一）">
<meta property="og:url" content="http://yoursite.com/2014/11/09/android-interview-i/">
<meta property="og:site_name" content="月光独奏">
<meta property="og:description" content="目录

JVM和DVM的不同
Android如何启动一个应用
UI Thread 如何工作
UI Thread 消息机制 API 概览
阐述 MessageQueue.IdleHandler
Android 平台如何调度线程
Android下线程有哪些通信方式
进程间如何通信
Android 如何管理内存 


1. JVM和DVM的不同

JVM is a stack-based machine">
<meta property="og:image" content="https://msolomoon.github.io/images/Zygote_VM_Startup.png">
<meta property="og:image" content="https://msolomoon.github.io/images/the_ui_thread_message_passing_api.png">
<meta property="og:image" content="https://msolomoon.github.io/images/IPC_through_Binder.png">
<meta property="og:image" content="https://msolomoon.github.io/images/AIDL_remote_procedure.png">
<meta property="og:image" content="https://msolomoon.github.io/images/Davilk_GC_Mark_workway.png">
<meta property="og:image" content="https://msolomoon.github.io/images/Activity_lifecycle_with_executing_thread.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 面试题纪录（一）">
<meta name="twitter:description" content="目录

JVM和DVM的不同
Android如何启动一个应用
UI Thread 如何工作
UI Thread 消息机制 API 概览
阐述 MessageQueue.IdleHandler
Android 平台如何调度线程
Android下线程有哪些通信方式
进程间如何通信
Android 如何管理内存 


1. JVM和DVM的不同

JVM is a stack-based machine">

  
    <link rel="alternative" href="/atom.xml" title="月光独奏" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="http://msolo-programmer.qiniudn.com/msolo_me_square.png">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">月光独奏</a></h1>
		</hgroup>

		
		<p class="header-subtitle">软件设计及开发者</p>
		

		
			<div class="onoffswitch">
			    <input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch" checked>
			    <label class="onoffswitch-label" for="myonoffswitch">
			        <span class="onoffswitch-inner"></span>
			        <span class="onoffswitch-switch"></span>
			    </label>
			</div>
		

		<div class="switch-area">
			<section class="first-part">
				<nav class="header-menu">
					<ul>
					
						<li><a href="/">主页</a></li>
			        
						<li><a href="/archives">所有文章</a></li>
			        
						<li><a href="/categories/随笔">随笔</a></li>
			        
						<li><a href="/categories/摘录">摘录</a></li>
			        
						<li><a href="/categories/书籍">书籍</a></li>
			        
						<li><a href="/categories/Web">Web</a></li>
			        
						<li><a href="/categories/C-Cpp-Go">C/Cpp/Go</a></li>
			        
						<li><a href="/categories/java-android">Java/Android</a></li>
			        
						<li><a href="/categories/project">Project</a></li>
			        
						<li><a href="/categories/程序员日志">程序员日志</a></li>
			        
						<li><a href="/about">关于</a></li>
			        
					</ul>
				</nav>
				<nav class="header-nav">
					<div class="social">
						
							<a class="github" target="_blank" href="https://github.com/mSoloMoon" title="github">github</a>
				        
							<a class="weibo" target="_blank" href="http://t.qq.com/zhengguangyu_msolo" title="weibo">weibo</a>
				        
							<a class="email" target="_blank" href="mailto://yuezhi.msolo@outlook.com" title="email">email</a>
				        
							<a class="qq" target="_blank" href="/212499714" title="qq">qq</a>
				        
					</div>
				</nav>
			</section>
			
			
			<section class="second-part">
				<div class="widget tagcloud">
					<a href="/tags/Android/" style="font-size: 15.00px;">Android</a><a href="/tags/C/" style="font-size: 10.00px;">C++</a><a href="/tags/C-C/" style="font-size: 10.00px;">C/C++</a><a href="/tags/Go/" style="font-size: 10.00px;">Go</a><a href="/tags/IT问题录/" style="font-size: 10.00px;">IT问题录</a><a href="/tags/IT面试/" style="font-size: 15.00px;">IT面试</a><a href="/tags/Java/" style="font-size: 15.00px;">Java</a><a href="/tags/Java-Web/" style="font-size: 10.00px;">Java Web</a><a href="/tags/书籍/" style="font-size: 10.00px;">书籍</a><a href="/tags/养生/" style="font-size: 10.00px;">养生</a><a href="/tags/历史/" style="font-size: 10.00px;">历史</a><a href="/tags/哲学/" style="font-size: 10.00px;">哲学</a><a href="/tags/思考/" style="font-size: 13.33px;">思考</a><a href="/tags/持续集成/" style="font-size: 15.00px;">持续集成</a><a href="/tags/摘录/" style="font-size: 15.00px;">摘录</a><a href="/tags/生活记录/" style="font-size: 16.67px;">生活记录</a><a href="/tags/设计模式/" style="font-size: 10.00px;">设计模式</a><a href="/tags/软件开发/" style="font-size: 20.00px;">软件开发</a><a href="/tags/软件框架/" style="font-size: 11.67px;">软件框架</a><a href="/tags/软件调试/" style="font-size: 10.00px;">软件调试</a><a href="/tags/金融/" style="font-size: 10.00px;">金融</a><a href="/tags/随笔/" style="font-size: 18.33px;">随笔</a><a href="/tags/项目/" style="font-size: 13.33px;">项目</a>
				</div>
			</section>
			
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="http://msolo-programmer.qiniudn.com/msolo_me_square.png">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">月光独奏</a></h1>
			</hgroup>
			
			<p class="header-subtitle">软件设计及开发者</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories/随笔">随笔</a></li>
		        
					<li><a href="/categories/摘录">摘录</a></li>
		        
					<li><a href="/categories/书籍">书籍</a></li>
		        
					<li><a href="/categories/Web">Web</a></li>
		        
					<li><a href="/categories/C-Cpp-Go">C/Cpp/Go</a></li>
		        
					<li><a href="/categories/java-android">Java/Android</a></li>
		        
					<li><a href="/categories/project">Project</a></li>
		        
					<li><a href="/categories/程序员日志">程序员日志</a></li>
		        
					<li><a href="/about">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/mSoloMoon" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://t.qq.com/zhengguangyu_msolo" title="weibo">weibo</a>
			        
						<a class="email" target="_blank" href="mailto://yuezhi.msolo@outlook.com" title="email">email</a>
			        
						<a class="qq" target="_blank" href="/212499714" title="qq">qq</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <article id="post-android-interview-i" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/11/09/android-interview-i/" class="article-date">
  	<time datetime="2014-11-08T18:18:48.000Z" itemprop="datePublished">11月 9 2014</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/java-android/">java-android</a>
  </div>

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IT面试/">IT面试</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/软件开发/">软件开发</a></li></ul>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Android 面试题纪录（一）
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="目录">目录</h3>
<ol>
<li>JVM和DVM的不同</li>
<li>Android如何启动一个应用</li>
<li>UI Thread 如何工作</li>
<li>UI Thread 消息机制 API 概览</li>
<li>阐述 MessageQueue.IdleHandler</li>
<li>Android 平台如何调度线程</li>
<li>Android下线程有哪些通信方式</li>
<li>进程间如何通信</li>
<li>Android 如何管理内存 </li>
</ol>
<p><br></p>
<h3 id="1-_JVM和DVM的不同">1. JVM和DVM的不同</h3>
<ul>
<li>JVM is a stack-based machine; while DVM is register-based（执行相同任务比JVM使用更少的指令）;</li>
<li>A stack-based virtual machine must transfer data from registers to the operand stack before manipulating them. In contrast, a register-based VM operates by directly using virtual registers. This increases the relative size of instructions because they must specify which registers to use, but reduces the number of instructions that must be executed to achieve the same result.</li>
</ul>
<h3 id="2-_Android如何启动一个应用">2. Android如何启动一个应用</h3>
<p><img src="https://msolomoon.github.io/images/Zygote_VM_Startup.png" alt="Zygote启动应用流程"></p>
<ul>
<li>Android启动时将率先运行一个独特的进程<strong>Zygote</strong>。而Zygote将启动一虚拟机，该虚拟机将预先加载Android核心库并初始化各种共享资源体，最后它将使用套接字进行监听。 </li>
<li>当用户启动一个Android应用时，Zygote将创建一个虚拟机（通过写时复制（Copy-On-Write）的技术拷贝Zygote虚拟机）以便其运行，并以子进程的身份和其父进程共享内存。</li>
</ul>
<a id="more"></a>

<h3 id="3-_UI_Thread_如何工作">3. UI Thread 如何工作</h3>
<p>UI Thread 由平台内部 android.app.ActivityThread 类管理。</p>
<ul>
<li>默认情况下，为Android应用开发的代码都会通过主线程（UI Thread）运行；</li>
<li>如果应用不能在5秒内响应用户，那么用户将会看到一个显示ANR对话框并提供退出选项以允许用户终止该应用;</li>
<li>Android设计致力于同步人眼与硬件（屏幕）刷新率，这意味着Android每秒绘制屏幕60帧数；</li>
<li>Android平台线程通信拥有自己的处理机制（Message Passing Mechanism）。该机制以非阻塞生产者消费者模式实现，其生产者和消费者在消息传送时都不会被阻塞；另外生产者可往消息队列在任意时间任意位置中插入新的消息；</li>
<li>API 16之后，Android引进了一个新的Choreographer对象以监控帧数时序，并在连续丢掉30帧后在日志中予以丢帧的警告；</li>
</ul>
<p><strong>The UI thread Looper</strong></p>
<ul>
<li>UI Thread是唯一默认装配了Looper的线程，并且先于应用组件的初始化，另外该 Looper 不能通过 Looper.quit() 终止，否则抛出 RuntimeException；</li>
<li>关于UI Thread Looper和其它线程Looper的几点实用性区别: UI Thread Looper通过Looper.getMainLooper()可从任意位置获取；并且Looper是Android运行时环境是通过Looper.prepareMainLooper()方法装配的. 每一个应用只能进行装配一次，因此试图为其它线程装配将会抛出异常；</li>
</ul>
<p><strong>在 UI Thread 上捕捉异常</strong></p>
<ul>
<li>当应用启动时，Android 运行时有一个全局对象 UncaughtExceptionHandler。默认情况下，它将杀死该进程。</li>
<li>但我们可以对其进行覆盖方法。典型地，覆盖方法应该只是增加一些功能。示例如下：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Set new global handler</span></div><div class="line">Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">new</span> ErrorReportExceptionHandler());</div><div class="line"><span class="comment">// Error handler that redirects exception to the system default handler.</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorReportExceptionHandler</span></span></div><div class="line">    <span class="keyword">implements</span> <span class="title">Thread</span>.<span class="title">UncaughtExceptionHandler</span> {</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Thread.UncaughtExceptionHandler defaultHandler;</div><div class="line">    <span class="keyword">public</span> <span class="title">ErrorReportExceptionHandler</span>() {</div><div class="line">        <span class="keyword">this</span>.defaultHandler = Thread.getDefaultUncaughtExceptionHandler();</div><div class="line">    }</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">uncaughtException</span>(Thread thread, Throwable throwable) {</div><div class="line">        reportErrorToFile(throwable);</div><div class="line">        defaultHandler.uncaughtException(thread, throwable);</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>如何查看 UI Thread</strong></p>
<p>下面名为 com.eat 默认就是应用启动时的 UI Thread。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ adb shell ps -t | grep u0_a72</div><div class="line">USER      PID   PPID  VSIZE  RSS   WCHAN    PS         NAME</div><div class="line">u0_a72    <span class="number">4257</span>  <span class="number">144</span>   <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S com.eat</div><div class="line">u0_a72    <span class="number">4259</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S GC</div><div class="line">u0_a72    <span class="number">4262</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Signal Catcher</div><div class="line">u0_a72    <span class="number">4263</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S JDWP</div><div class="line">u0_a72    <span class="number">4264</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Compiler</div><div class="line">u0_a72    <span class="number">4265</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S ReferenceQueueDemon</div><div class="line">u0_a72    <span class="number">4266</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S FinalizerDaemon</div><div class="line">u0_a72    <span class="number">4267</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S FinalizerWatchdogDaemon</div><div class="line">u0_a72    <span class="number">4268</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Binder_1</div><div class="line">u0_a72    <span class="number">4269</span>  <span class="number">4257</span>  <span class="number">320304</span> <span class="number">34540</span> ffffffff <span class="number">00000000</span> S Binder_2</div></pre></td></tr></table></figure>

<p><strong>与UI Thread通信代码片段</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Runnable task = <span class="keyword">new</span> Runnable() {...};</div><div class="line"><span class="keyword">new</span> Handler(Looper.getMainLooper()).post(task);</div><div class="line"><span class="comment">// Method called on UI thread.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postFromUiThreadToUiThread</span>() {</div><div class="line">    <span class="keyword">new</span> Handler().post(<span class="keyword">new</span> Runnable() { ... }); <span class="comment">// 改行代码将成为目前正在执行消息处理的一部分，并在添加此新消息这个动作之前执行.</span></div><div class="line">}</div><div class="line"><span class="comment">// Method called on UI thread.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postFromUiThreadToUiThread</span>() {</div><div class="line">    runOnUiThread(<span class="keyword">new</span> Runnable() { ... }); <span class="comment">// The code at this point is executed after the message.</span></div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="4-_UI_Thread_消息机制_API_概览">4. UI Thread 消息机制 API 概览</h3>
<blockquote>
<p>android.os.Handler: 消费者线程消息处理器，提供接口予以生产者线程往队列插入消息. 一个Looper或许有多个与之关联的Handler，但只有一个队列。<br>android.os.Looper: 一次只有一个并只与消费者线程关联的消息分发器。<br>android.os.MessageQueue: 无边界链表结构，每一个Looper和线程最多拥有一个消息队列。<br>android.os.Message: 在消费者线程进行消费的消息。</p>
</blockquote>
<p><img src="https://msolomoon.github.io/images/the_ui_thread_message_passing_api.png" alt="message-passing机制概览"></p>
<ul>
<li>Insert: 生产者线程通过与消费者线程关联的Handler往队列插入消息。</li>
<li>Retrieve: 通过Looper顺序地从队列取出消息以供消费者线程消费。</li>
<li>Dispatch: 由Looper负责保证将消息分发到正确的Handler。 </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 示例: Basic Message Passing</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LooperActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>{</div><div class="line">    LooperThread mLooperThread;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LooperThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{ <span class="comment">// 该线程负责插入消息</span></div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">            Looper.prepare(); </div><div class="line">            mHandler = <span class="keyword">new</span> Handler() { </div><div class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) { </div><div class="line">                    <span class="keyword">if</span>(msg.what == <span class="number">0</span>) { doLongRunningOperation(); }</div><div class="line">                }</div><div class="line">            };</div><div class="line">            Looper.loop(); <span class="comment">// 开始从队列取消息并分发到消费者线程，这是一个阻塞调用，</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Bundle savedInstanceState) {</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        mLooperThread = <span class="keyword">new</span> LooperThread(); </div><div class="line">        mLooperThread.start();</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span>(View v) {</div><div class="line">        <span class="keyword">if</span> (mLooperThread.mHandler != <span class="keyword">null</span>) {</div><div class="line">            Message msg = mLooperThread.mHandler.obtainMessage(<span class="number">0</span>); </div><div class="line">            mLooperThread.mHandler.sendMessage(msg); <span class="comment">// 往队列插入消息</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doLongRunningOperation</span>() {</div><div class="line">        <span class="comment">// Add long running operation here.</span></div><div class="line">    }</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span>() {</div><div class="line">        mLooperThread.mHandler.getLooper().quit(); <span class="comment">// Terminate the background thread.</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="5-_阐述_MessageQueue-IdleHandler">5. 阐述 MessageQueue.IdleHandler</h3>
<blockquote>
<p>如果当前没有消息要处理，这时，消费者线程将处于空闲时段，与其等待消息的道来，其它线程将会在此空闲时段获得机会执行。<br>When the message queue detects idle time for the consumer thread, it invokes queueIdle() on all registered IdleHandler-instances. It is up to the application to implement the callback responsibly. </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Get the message queue of the current thread.</span></div><div class="line">MessageQueue mq = Looper.myQueue();</div><div class="line"><span class="comment">// Create and register an idle listener.</span></div><div class="line">MessageQueue.IdleHandler idleHandler = <span class="keyword">new</span> MessageQueue.IdleHandler();</div><div class="line">mq.addIdleHandler(idleHandler)</div><div class="line"><span class="comment">// Unregister an idle listener.</span></div><div class="line">mq.removeIdleHandler(idleHandler)</div><div class="line"></div><div class="line">interface IdleHandler {</div><div class="line">    <span class="keyword">boolean</span> queueIdle();</div><div class="line">}</div><div class="line"><span class="comment">// 实现该接口的 queueIdle() 方法必须返回一个具有以下含义的布尔值：</span></div><div class="line"><span class="comment">// true: The idle handler is kept active; it will continue to receive callbacks for successive idle time slots.</span></div><div class="line"><span class="comment">// false: The idle handler is inactive; it will not receive anymore callbacks for successive idle time slots.</span></div></pre></td></tr></table></figure>

<h3 id="6-_Android_平台如何调度线程">6. Android 平台如何调度线程</h3>
<p><strong>Priority</strong>：更改线程执行的优先级</p>
<ul>
<li>java.lang.Thread: </li>
<li>setPriority(int priority);    // from 0 (least prioritized) to 10 (most prioritized).</li>
<li>android.os.Process</li>
<li>Process.setThreadPriority(int priority); // 在执行的线程里.</li>
<li>Process.setThreadPriority(int threadId, int priority);</li>
</ul>
<p><strong>Control group</strong>：更改线程所属的控制组（control group，Android 特有）  </p>
<ul>
<li>Android 自定义了很多控制组，但最重要的是前端（Foreground）控制组和后端（Background）控制组。</li>
<li>默认创建的线程和 UI Thread 拥有相同的优先级和控制组，因此它们将为获得处理器资源而互相竞争。为了避免大量后台线程影响 UI Thread 的性能，可通过如下方式解决。</li>
<li>更改所属控制组：Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND)  </li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ adb shell ps -P | grep u0_a72		<span class="comment"># 显示前台线程 : fg</span></div><div class="line">u0_a72    <span class="number">4257</span>  <span class="number">144</span>   <span class="number">320304</span> <span class="number">34504</span> fg  ffffffff <span class="number">00000000</span> S com.eat</div></pre></td></tr></table></figure>

<h3 id="7-_Android下线程有哪些通信方式（数据结构）">7. Android下线程有哪些通信方式（数据结构）</h3>
<p><strong>管道</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> BUFFER_SIZE_IN_CHARS = <span class="number">1024</span> * <span class="number">4</span>;</div><div class="line">PipedReader r = <span class="keyword">new</span> PipedReader(BUFFER_SIZE_IN_CHARS);	<span class="comment">// 默认 1024 字节</span></div><div class="line">PipedWriter w = <span class="keyword">new</span> PipedWriter(r);</div><div class="line">Thread t = <span class="keyword">new</span> MyReaderThread(r);</div><div class="line">t.start();</div><div class="line"><span class="comment">// Producer thread: Flush the pipe after a write.</span></div><div class="line">w.write(<span class="string">'A'</span>);</div><div class="line">w.flush();</div><div class="line"><span class="comment">// Consumer thread: Read the data in a loop.</span></div><div class="line"><span class="keyword">int</span> i;</div><div class="line"><span class="comment">// when the buffer is empty, the PipedReader uses a blocking call to wait() with one-second timeout.</span></div><div class="line"><span class="keyword">while</span>((i = reader.read()) != -<span class="number">1</span>){	</div><div class="line">    <span class="keyword">char</span> c = (<span class="keyword">char</span>) i; </div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line">w.close();</div><div class="line">r.close();</div></pre></td></tr></table></figure>

<p><strong>共享内存</strong></p>
<p><strong>信号量</strong>（该技术被认为是最容易出错的技术）</p>
<ul>
<li>synchronized: Object.wait() / Object.wait(timeout); Object.notify() / Object.notifyAll()</li>
<li>ReentrantLock: Condition.await() / Condition.await(timeout); Condition.signal() / Condition.signalAll()</li>
<li>ReentrantReadWriteLock: Condition.await() / Condition.await(timeout); Condition.signal() / Condition.signalAll() </li>
</ul>
<p><strong>阻塞队列</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerProducer</span> </span>{</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> LIMIT = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> BlockingQueue&lt;Integer&gt; blockingQueue = <span class="keyword">new</span> LinkedBlockingQueue&lt;Integer&gt;(LIMIT);</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span>() <span class="keyword">throws</span> InterruptedException {</div><div class="line">        <span class="keyword">int</span> value = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            blockingQueue.put(value++);</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consume</span>() <span class="keyword">throws</span> InterruptedException {</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</div><div class="line">            <span class="keyword">int</span> value = blockingQueue.take();</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>Android Message Passing</strong>（参考第4题）</p>
<ul>
<li>The lifecycle of a message: create(<strong>initialized</strong>) -&gt; enqueue(<strong>pending</strong>) -&gt; dispatch(<strong>dispatched</strong>) -&gt; recycle(<strong>recycled</strong>) -&gt; (<strong>initialized</strong>)</li>
</ul>
<blockquote>
<p>创建消息的 API:<br>Message m  = new Message();<br>Message m = Message.obtain();    // empty message<br>Message m = Message.obtain(Handler h);<br>Message m = Message.obtain(Handler h, int what);<br>Message m = Message.obtain(Handler h, int what, Object o);<br>Message m = Message.obtain(Handler h, int what, int arg1, int arg2);<br>Message m = Message.obtain(Handler h, int what, int arg1, int arg2, Object o);<br>Message m = Message.obtain(Handler h, Runnable task);    // task message<br>Message m = Message.obtain(Message originalMsg); // copy constructor</p>
</blockquote>
<p><strong>Handler</strong></p>
<ul>
<li>Constructors without an explicit Looper bind to the Looper of the current thread: new Handler(); 或    new Handler(Handler.Callback)</li>
<li>Constructors with an explicit Looper bind to that Looper: new Handler(Looper); 或 new Handler(Looper, Handler.Callback);</li>
<li>Message insertion, The sorting is based on the time parameter, and it is the only way an application can affect the dispatch order: <strong>default</strong>（Immediately eligible for dispatch），<strong>at_front</strong>（dispatch at time 0. Hence, it will be the next dispatched message, unless another is inserted at the front before this one is processed）, <strong>delay</strong>（The amount of time after which this message is eligible for dispatch），<strong>uptime</strong>（The absolute time at which this message is eligible for dispatch）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 往消息队列中添加任务:</span></div><div class="line"><span class="keyword">boolean</span> post(Runnable r)</div><div class="line"><span class="keyword">boolean</span> postAtFrontOfQueue(Runnable r)</div><div class="line"><span class="keyword">boolean</span> postAtTime(Runnable r, Object token, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> postAtTime(Runnable r, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> postDelayed(Runnable r, <span class="keyword">long</span> delayMillis)</div><div class="line"><span class="comment">// 往消息队列中添加消息实体:</span></div><div class="line"><span class="keyword">boolean</span> sendMessage(Message msg)</div><div class="line"><span class="keyword">boolean</span> sendMessageAtFrontOfQueue(Message msg)</div><div class="line"><span class="keyword">boolean</span> sendMessageAtTime(Message msg, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> sendMessageDelayed(Message msg, <span class="keyword">long</span> delayMillis)</div><div class="line"><span class="comment">// 往消息队列中添加简单的分发指示:</span></div><div class="line"><span class="keyword">boolean</span> sendEmptyMessage(<span class="keyword">int</span> what)</div><div class="line"><span class="keyword">boolean</span> sendEmptyMessageAtTime(<span class="keyword">int</span> what, <span class="keyword">long</span> uptimeMillis)</div><div class="line"><span class="keyword">boolean</span> sendEmptyMessageDelayed(<span class="keyword">int</span> what, <span class="keyword">long</span> delayMillis)</div><div class="line"><span class="comment">// 插入时可能发生的错误</span></div><div class="line"><span class="comment">// RuntimeException: Message has no Handler; Message has already been dispatched and is being processed.</span></div><div class="line"><span class="comment">// Return false: Message is inserted after Looper.quit() has been called.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// 示例1</span></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{</div><div class="line">    <span class="keyword">private</span> Handler mBackgroundHandler;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() { </div><div class="line">        Looper.prepare();</div><div class="line">        mBackgroundHandler = <span class="keyword">new</span> Handler(); </div><div class="line">        Looper.loop();</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doWork</span>() {</div><div class="line">        mBackgroundHandler.post(<span class="keyword">new</span> Runnable() { </div><div class="line">        		<span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">        				Message uiMsg = mUiHandler.obtainMessage(SHOW_PROGRESS_BAR, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>); </div><div class="line">        				mUiHandler.sendMessage(uiMsg); </div><div class="line">        				Random r = <span class="keyword">new</span> Random();</div><div class="line">        				<span class="keyword">int</span> randomInt = r.nextInt(<span class="number">5000</span>);</div><div class="line">        				SystemClock.sleep(randomInt); </div><div class="line">        				uiMsg = mUiHandler.obtainMessage(HIDE_PROGRESS_BAR, randomInt, <span class="number">0</span>, <span class="keyword">null</span>); </div><div class="line">        				mUiHandler.sendMessage(uiMsg); </div><div class="line">        		}</div><div class="line">        });</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exit</span>() { </div><div class="line">        mBackgroundHandler.getLooper().quit();</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">// 示例2</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler mUiHandler = <span class="keyword">new</span> Handler() {</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">        <span class="keyword">switch</span>(msg.what) {</div><div class="line">            <span class="keyword">case</span> SHOW_PROGRESS_BAR: </div><div class="line">                mProgressBar.setVisibility(View.VISIBLE);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> HIDE_PROGRESS_BAR:</div><div class="line">                mText.setText(String.valueOf(msg.arg1));</div><div class="line">                mProgressBar.setVisibility(View.INVISIBLE);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">};</div><div class="line"><span class="comment">// 示例3</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerCallbackActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">Handler</span>.<span class="title">Callback</span> </span>{</div><div class="line">    <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span>(Message msg) { </div><div class="line">        <span class="keyword">switch</span> (msg.what) {</div><div class="line">            <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                msg.what = <span class="number">11</span>;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                msg.what = <span class="number">22</span>;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onHandlerCallback</span>(View v) {  <span class="comment">// 此处为 button 的点击事件处理器</span></div><div class="line">        Handler handler = <span class="keyword">new</span> Handler(<span class="keyword">this</span>) {</div><div class="line">            <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">                <span class="comment">// Process message </span></div><div class="line">            }</div><div class="line">        };</div><div class="line">        handler.sendEmptyMessage(<span class="number">1</span>); </div><div class="line">        handler.sendEmptyMessage(<span class="number">2</span>); </div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 移除任务</span></div><div class="line">removeCallbacks(Runnable r)</div><div class="line">removeCallbacks(Runnable r, Object token)</div><div class="line"><span class="comment">// 移除简单指示实体</span></div><div class="line">removeMessages(<span class="keyword">int</span> what)</div><div class="line">removeMessages(<span class="keyword">int</span> what, Object object)</div><div class="line"><span class="comment">// Remove tasks and data messages from the message queue</span></div><div class="line">removeCallbacksAndMessages(Object token)</div><div class="line"><span class="comment">// Taking a snapshot of the current message queue</span></div><div class="line">mWorkerHandler.dump(<span class="keyword">new</span> LogPrinter(Log.DEBUG, TAG), <span class="string">""</span>);</div><div class="line"><span class="comment">// Tracing the message queue processing</span></div><div class="line">Looper.myLooper().setMessageLogging(<span class="keyword">new</span> LogPrinter(Log.DEBUG, TAG));</div></pre></td></tr></table></figure>

<h3 id="8-_进程间如何通信">8. 进程间如何通信</h3>
<p><strong>Android RPC</strong></p>
<ul>
<li>IPC由Linux系统管理，支持以下几种IPC机制: signals, pipes, message queues, semaphores, and shared memory. 而经过修改过的Android版Linux，其IPC机制已被替换为binder框架，该框架使用RPC方式在进程间通信。IPC可以是双通道的。</li>
</ul>
<blockquote>
<p>RPC方式通信包含以下步骤：</p>
<ol>
<li>Method and data decomposition, also known as marshalling</li>
<li>Transferring the marshalled information to the remote process</li>
<li>Recomposing the information in the remote process, also known as unmarshalling</li>
<li>Transferring return values back to the originating process</li>
</ol>
</blockquote>
<p><strong>Binder</strong></p>
<p><img src="https://msolomoon.github.io/images/IPC_through_Binder.png" alt="IPC through binder"></p>
<ul>
<li>客户端线程在交互时默认是阻塞的，直到远程的线程完成onTransact()方法。</li>
<li>交互数据由对象android.os.Parcel组成, 该对象经过优化以便通过Binder和进程交互。</li>
<li>onTransact()方法在binder线程池中的某一线程执行。该线程池存在的意义只在于为了处理从其它进程而来的消息；并且它最多只能有16个线程。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Message Passing Using the Binder : One-Way Communication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerThreadService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>{</div><div class="line">    WorkerThread mWorkerThread;</div><div class="line">    Messenger mWorkerMessenger;</div><div class="line">    <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>() {</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        mWorkerThread.start(); </div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> IBinder <span class="title">onBind</span>(Intent intent) { </div><div class="line">        <span class="keyword">return</span> mWorkerMessenger.getBinder();</div><div class="line">    }</div><div class="line">    <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span>() {</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        mWorkerThread.quit();</div><div class="line">    }</div><div class="line">    <span class="javadoc">/**</span></div><div class="line">    * Worker thread has prepared a looper and handler.</div><div class="line">    **/</div><div class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onWorkerPrepared</span>() {</div><div class="line">        mWorkerMessenger = <span class="keyword">new</span> Messenger(mWorkerThread.mWorkerHandler); </div><div class="line">    }</div><div class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{</div><div class="line">        Handler mWorkerHandler;</div><div class="line">        <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">            Looper.prepare();</div><div class="line">            mWorkerHandler = <span class="keyword">new</span> Handler() {</div><div class="line">                <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) { </div><div class="line">                    <span class="comment">// Implement message processing</span></div><div class="line">                }</div><div class="line">            };</div><div class="line">            onWorkerPrepared();</div><div class="line">            Looper.loop();</div><div class="line">        }</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span>() {</div><div class="line">            mWorkerHandler.getLooper().quit();</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessengerOnewayActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>{</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mBound = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">private</span> Messenger mRemoteService = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">private</span> ServiceConnection mRemoteConnection = <span class="keyword">new</span> ServiceConnection() {</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span>(ComponentName className, IBinder service) {</div><div class="line">            mRemoteService = <span class="keyword">new</span> Messenger(service); </div><div class="line">            mBound = <span class="keyword">true</span>;</div><div class="line">        }</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span>(ComponentName className) {</div><div class="line">            mRemoteService = <span class="keyword">null</span>;</div><div class="line">            mBound = <span class="keyword">false</span>;</div><div class="line">        }</div><div class="line">    };</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span>(Bundle savedInstanceState) {</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.wifill.eatservice.ACTION_BIND"</span>);</div><div class="line">        bindService(intent, mRemoteConnection, Context.BIND_AUTO_CREATE); </div><div class="line">    }</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSendClick</span>(View v) {</div><div class="line">        <span class="keyword">if</span> (mBound) {</div><div class="line">            mRemoteService.send(Message.obtain(<span class="keyword">null</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>)); </div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">// Two-Way Communication</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">    Looper.prepare();</div><div class="line">    mWorkerHandler = <span class="keyword">new</span> Handler() {</div><div class="line">        <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">            <span class="keyword">switch</span> (msg.what) {</div><div class="line">                <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">                    <span class="keyword">try</span> {</div><div class="line">                        msg.replyTo.send(Message.obtain(<span class="keyword">null</span>, msg.what, <span class="number">0</span>, <span class="number">0</span>));</div><div class="line">                    } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">                        Log.e(TAG, e.getMessage());</div><div class="line">                    }</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                }</div><div class="line">            }</div><div class="line">        };</div><div class="line">        onWorkerPrepared();</div><div class="line">        Looper.loop();</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSendClick</span>(View v) {</div><div class="line">    <span class="keyword">if</span> (mBound) {</div><div class="line">        <span class="keyword">try</span> {</div><div class="line">            Message msg = Message.obtain(<span class="keyword">null</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">            msg.replyTo = <span class="keyword">new</span> Messenger(<span class="keyword">new</span> Handler() { </div><div class="line">                <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">                    Log.d(TAG, <span class="string">"Message sent back - msg.what = "</span> + msg.what);</div><div class="line">                }</div><div class="line">            });</div><div class="line">            mRemoteService.send(msg);</div><div class="line">        } <span class="keyword">catch</span> (RemoteException e) {</div><div class="line">           Log.e(TAG, e.getMessage());</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>



<p><strong>AIDL（Android Interface Definition Language）</strong></p>
<p><img src="https://msolomoon.github.io/images/AIDL_remote_procedure.png" alt="AIDL remote procedure"></p>
<ul>
<li>The generated Java interface is included in all the client applications and in the server application. The interface file defines two inner classes,  Proxy and  Stub, that handle all the marshalling and unmarshalling of the data, as well as the transaction itself. </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Synchronous RPC : ISynchronous.aidl</span></div><div class="line">interface ISynchronous {</div><div class="line">    String getThreadNameFast();</div><div class="line">    String getThreadNameSlow(<span class="keyword">long</span> sleep);</div><div class="line">    String getThreadNameBlocking();</div><div class="line">    String getThreadNameUnblock();</div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ISynchronous.Stub mBinder = <span class="keyword">new</span> ISynchronous.Stub() {</div><div class="line">    CountDownLatch mLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> String <span class="title">getThreadNameFast</span>() <span class="keyword">throws</span> RemoteException {</div><div class="line">        <span class="keyword">return</span> Thread.currentThread().getName();</div><div class="line">    }</div><div class="line">    <span class="comment">//...</span></div><div class="line">}</div><div class="line"><span class="comment">//</span></div><div class="line">ISynchronous mISynchronous = ISynchronous.Stub.asInterface(binder);</div><div class="line">String remoteThreadName = mISynchronous.getThreadNameFast();</div></pre></td></tr></table></figure>

<p><strong>异步 RPC</strong>（在 AIDL 中通过关键字 oneway 定义）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Asynchronous interface</span></div><div class="line">oneway interface IAsynchronousInterface {</div><div class="line">    <span class="keyword">void</span> method1();</div><div class="line">    <span class="keyword">void</span> method2();</div><div class="line">}</div><div class="line"><span class="comment">// Asynchronous method</span></div><div class="line">interface IAsynchronousInterface {</div><div class="line">    oneway <span class="keyword">void</span> method1();</div><div class="line">    <span class="keyword">void</span> method2();</div><div class="line">}</div><div class="line"><span class="comment">// 示例1</span></div><div class="line">interface IAsynchronous1 {</div><div class="line">    oneway <span class="keyword">void</span> getThreadNameSlow(IAsynchronousCallback callback);</div><div class="line">}</div><div class="line"><span class="comment">// The implementation of the remote interface in the server process</span></div><div class="line">IAsynchronous1.Stub mIAsynchronous1 = <span class="keyword">new</span> IAsynchronous1.Stub() {</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getThreadNameSlow</span>(IAsynchronousCallback callback) <span class="keyword">throws</span> RemoteException {</div><div class="line">        String threadName = Thread.currentThread().getName();</div><div class="line">        SystemClock.sleep(<span class="number">10000</span>);</div><div class="line">        callback.handleResult(threadName);</div><div class="line">    }</div><div class="line">};</div><div class="line">interface IAsynchronousCallback {</div><div class="line">    <span class="keyword">void</span> handleResult(String name);</div><div class="line">}</div><div class="line"><span class="comment">// And the implementation of the callback interface in the client process handles the result:</span></div><div class="line"><span class="keyword">private</span> IAsynchronousCallback.Stub mCallback = <span class="keyword">new</span> IAsynchronousCallback.Stub() {</div><div class="line">    <span class="annotation">@Override</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleResult</span>(String remoteThreadName) <span class="keyword">throws</span> RemoteException {</div><div class="line">        Log.d(TAG, <span class="string">"remoteThreadName = "</span> + name);</div><div class="line">        Log.d(TAG, <span class="string">"currentThreadName = "</span> + Thread.currentThread().getName());</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h3 id="9-_Android_如何管理内存">9. Android 如何管理内存</h3>
<blockquote>
<p>内存泄漏的广泛定义：</p>
<ol>
<li>内存没有被回收；</li>
<li>内存一次分配过多，有可能导致内存耗尽；</li>
</ol>
</blockquote>
<ul>
<li>GC 使用标记-清扫方式（mark-and-sweep）;</li>
<li>其标记工作方式如下图所示</li>
</ul>
<p><img src="https://msolomoon.github.io/images/Davilk_GC_Mark_workway.png" alt="GC 标记工作方式"></p>
<blockquote>
<p>注：任何可以在堆（heap）外访问到的对象都统称为 GC root，这包括静态对象（static objects）、在堆栈的本地对象（local objects）和线程。<br>GC root A→A1→A2<br>GC root B→B1→B2→B3→B4<br>GC root B→B1→B2→B4</p>
</blockquote>
<p><strong>与线程相关的内存泄漏</strong></p>
<ul>
<li>当线程执行时，线程对象本身便成为GC root，所有线程创建的相关对象都将被标记为不可回收；</li>
<li>当线程实现为内部类时，该线程对象将持有其外部类对象的引用，因此，只要线程不终止，外部类对象将不可回收；</li>
<li>当线程实现为静态内部类时，线程对象持有外部类的引用，但不是外部类对象，因此外部类对象在没有其它引用链接它时可被回收；但如果程序员想将线程执行的环境（Thread）和执行对象（Runnable）分开，并将执行对象实现为内部类时，该执行对象将获得对线程外部类对象的一个引用，从而导致外部类对象不可被回收, 如下示例；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Outer</span> </span>{</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sampleMethod</span>() {</div><div class="line">        SampleThread sampleThread = <span class="keyword">new</span> SampleThread(<span class="keyword">new</span> Runnable() {</div><div class="line">            <span class="annotation">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">                Object sampleObject = <span class="keyword">new</span> Object();</div><div class="line">                <span class="comment">// Do execution</span></div><div class="line">            }</div><div class="line">        });</div><div class="line">        sampleThread.start();</div><div class="line">    }</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>{</div><div class="line">        <span class="keyword">public</span> <span class="title">SampleThread</span>(Runnable runnable) {</div><div class="line">            <span class="keyword">super</span>(runnable);</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<ul>
<li>Android 应用组件与线程之间生命期的不协调，比如下图所示，Activity 对象在生命期结束后（onDestroy()）仍然停留在堆上，其原因是 Activity 在活动期间启动的一线程仍在运行当中。</li>
</ul>
<p><img src="https://msolomoon.github.io/images/Activity_lifecycle_with_executing_thread.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 示例1：发送一数据消息，该示例演示了广义上的内存泄漏</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Outer</span> </span>{</div><div class="line">    Handler mHandler = <span class="keyword">new</span> Handler() {</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">            <span class="comment">// Handle message</span></div><div class="line">        }</div><div class="line">    };</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSend</span>() {</div><div class="line">        Message message = mHandler.obtainMessage();</div><div class="line">        message.obj = <span class="keyword">new</span> SampleObject();</div><div class="line">        mHandler.sendMessageDelayed(message, <span class="number">60</span> * <span class="number">1000</span>);</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">// 示例2：寄送一任务消息（Posting a task message）</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Outer</span> </span>{</div><div class="line">    Handler mHandler = <span class="keyword">new</span> Handler() {</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span>(Message msg) {</div><div class="line">            <span class="comment">// Handle message</span></div><div class="line">        }</div><div class="line">    };</div><div class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPost</span>() {</div><div class="line">        mHandler.post(<span class="keyword">new</span> Runnable() {</div><div class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span>() {</div><div class="line">                <span class="comment">// Long running task</span></div><div class="line">            }</div><div class="line">        });</div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<p><strong>如何避免内存泄漏</strong></p>
<ul>
<li>使用静态内部类；</li>
<li>使用弱引用（Weak References）；显式置空强引用（strong references）；</li>
<li>及时停止线程执行；</li>
</ul>

      
    </div>
    <footer class="article-footer">
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/11/09/begin-hello-world/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          程序员的自我修养 - 从Hello World！说起
        
      </div>
    </a>
  
  
    <a href="/2014/11/08/project-stockeye-package-calendarstock/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Stockeye项目 - CalendarStock包（初步设计）</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="android-interview-i" data-title="Android 面试题纪录（一）" data-url="http://yoursite.com/2014/11/09/android-interview-i/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2014 月光独奏
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>

  <script src="/js/main.js" type="text/javascript"></script>


  </div>
</body>
</html>